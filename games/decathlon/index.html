<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D√©cathlon ‚Äì Mission Rythme</title>

  <link rel="stylesheet" href="../../assets/css/style.css" />
  <link rel="stylesheet" href="../../assets/css/decathlon.css" />



</head>

<body class="scanlines">
  

  <div class="page-shell grid-overlay">
    <div class="wave-bg"></div>
      <div class="sticky-footer">
        <a class="btn" href="../../level-select.html">Back to home</a>
      </div>

    <div class="game-shell card neon-border sport">

      <img id="exercise-image" alt="Exercice" />
      
      <div id="rhythm-game-area">
          <div id="key-sequence">
              </div>
          <div id="hit-target"></div>
          <div id="rhythm-message"></div> </div>
      
    </div>
  </div>
</body>
</html>

<script>

  // Constantes DOM
  const availableKeys = 'qsdfghjklm'; 
  const image = document.getElementById("exercise-image");
  const keySequenceElement = document.getElementById("key-sequence");
  const rhythmMessageElement = document.getElementById("rhythm-message");
  const hitTargetElement = document.getElementById('hit-target');
  
  // Constantes de jeu
  const TIME_TO_HIT = 2000; // Temps de d√©filement de la note (2.0 secondes)
  const HIT_WINDOW = 500; // Marge d'erreur de frappe (+/- 250ms)

  // --- VARIABLES DE DIFFICULT√â (ESPACEMENT TEMPOREL) ---
  let keySpacing = 1500; // Intervalle initial de g√©n√©ration des touches (1500ms = 1.5s)
  const MIN_KEY_SPACING = 300; // Intervalle minimum (300ms)
  const SPACING_DECREMENT = 50; // Diminution de l'intervalle √† chaque hit (50ms)

  let gameActive = true; 
  let isLowPosition = false; 
  let keyGeneratorInterval; 

  // File d'attente des notes
  const activeKeys = []; 
  
  // Variables d'exercice
  const params = new URLSearchParams(window.location.search);
  const lastAnswer = params.get("profile");
  const BASE_PATH = "../../assets/images/bee/";
  let HIGH_POS_FILE = "";
  let LOW_POS_FILE = ""; 


  // --- LOGIQUE D'IMAGE ET D√âFAITE ---

  function determineExercisePaths(answer) {
    switch (answer) {
      case "A": HIGH_POS_FILE = "pompe_haut.webp"; LOW_POS_FILE = "pompe_bas.webp"; break;
      case "B": HIGH_POS_FILE = "curl_haut.webp"; LOW_POS_FILE = "curl_bas.webp"; break;
      case "C": HIGH_POS_FILE = "fente_haut.webp"; LOW_POS_FILE = "fente_bas.webp"; break;
      case "D": HIGH_POS_FILE = "squat_haut.webp"; LOW_POS_FILE = "squat_bas.webp"; break;
      default: return false;
    }
    return true;
  }
  
  function setHighPosition() { image.src = BASE_PATH + HIGH_POS_FILE; isLowPosition = false; }
  function setLowPosition() { image.src = BASE_PATH + LOW_POS_FILE; isLowPosition = true; }
  function switchPosition() { isLowPosition ? setHighPosition() : setLowPosition(); }


  /**
   * üõë Arr√™te le jeu (rat√© de timing, mauvaise touche, ou note manqu√©e).
   */
  function gameOver() {
      if (!gameActive) return;
      gameActive = false;
      
      clearInterval(keyGeneratorInterval); 
      document.querySelectorAll('.key-note').forEach(note => note.style.animationPlayState = 'paused');

      hitTargetElement.style.backgroundColor = '#ff0000';
      hitTargetElement.style.boxShadow = '0 0 20px #ff0000';
      
      rhythmMessageElement.textContent = "PERDU !";
      rhythmMessageElement.style.color = '#ff0000';
      rhythmMessageElement.style.fontSize = '4em';

      console.log("GAME OVER.");
  }

  /**
   * ‚ùå V√©rifie si la note a √©t√© manqu√©e apr√®s son passage.
   * La d√©faite est imm√©diate au moment o√π la note sort du temps imparti.
   */
  function checkMissedNote(noteElement) {
      const target = activeKeys[0]; 
      
      // La note a d√©pass√© la fen√™tre de frappe sans √™tre frapp√©e
      if (target && target.element === noteElement) {
          console.log(`‚ùå NOTE MANQU√âE : ${target.key} (Sortie)`);
          activeKeys.shift(); 
          noteElement.style.backgroundColor = 'rgba(255, 0, 0, 0.5)';
          gameOver(); // **D√âFAITE IMM√âDIATE**
      }
      
      if (noteElement.parentNode) {
          noteElement.parentNode.removeChild(noteElement);
      }
  }


  /**
   * ‚ûï G√©n√®re une nouvelle note et lance l'animation.
   */
  function addKeyToSequence() {
      if (!gameActive) return;

      const randomIndex = Math.floor(Math.random() * availableKeys.length);
      const newKey = availableKeys[randomIndex];

      const noteElement = document.createElement('div');
      noteElement.className = 'key-note';
      noteElement.textContent = newKey.toUpperCase();
      
      // Le temps d'arriv√©e n'est plus utilis√© pour le spawning, seulement le scoring.
      const arrivalTime = Date.now() + TIME_TO_HIT;

      keySequenceElement.appendChild(noteElement);

      noteElement.style.animation = `scroll-key ${TIME_TO_HIT / 1000}s linear forwards`;

      activeKeys.push({
          key: newKey,
          element: noteElement,
          arrivalTime: arrivalTime,
      });

      // Planifier la v√©rification de 'rat√©' : imm√©diatement apr√®s la fen√™tre de frappe
      setTimeout(() => {
          checkMissedNote(noteElement);
      }, TIME_TO_HIT + HIT_WINDOW);
  }


  /**
   * ‚å®Ô∏è G√®re l'√©v√©nement de pression de touche par le joueur.
   */
  document.addEventListener('keydown', (event) => {
      if (!gameActive || activeKeys.length === 0) return;

      const pressedKey = event.key.toLowerCase();
      const targetNote = activeKeys[0]; 

      // 1. V√©rifier la touche
      if (pressedKey === targetNote.key) {
          
          const currentTime = Date.now();
          const diff = targetNote.arrivalTime - currentTime; 

          // 2. V√©rifier le timing
          if (Math.abs(diff) <= HIT_WINDOW) {
              // SUCC√àS - FRAPPE CORRECTE
              
              switchPosition(); 
              
              // --- LOGIQUE DE DIFFICULT√â PAR ESPACEMENT (TEMPS) ---
              if (keySpacing > MIN_KEY_SPACING) {
                  keySpacing -= SPACING_DECREMENT;
                  if (keySpacing < MIN_KEY_SPACING) {
                      keySpacing = MIN_KEY_SPACING;
                  }
                  
                  // Mettre √† jour l'intervalle de g√©n√©ration des cl√©s
                  clearInterval(keyGeneratorInterval);
                  keyGeneratorInterval = setInterval(addKeyToSequence, keySpacing);
                  console.log(`Nouvel intervalle de spawn : ${keySpacing}ms`);
              }

              // Effet visuel de succ√®s et suppression
              targetNote.element.style.backgroundColor = '#ffff00';
              targetNote.element.style.color = '#000';
              targetNote.element.style.boxShadow = '0 0 10px #ffff00';
              
              activeKeys.shift(); 
              targetNote.element.remove(); 
              
          } else {
              // √âCHEC - MAUVAIS TIMING
              console.log(`‚ùå BAD TIMING: ${targetNote.key}`);
              gameOver();
          }

      } 
      // 3. Touche incorrecte
      else if (availableKeys.includes(pressedKey)) {
          console.log(`‚ö†Ô∏è Touche incorrecte : ${pressedKey}`);
          gameOver(); 
      }
  });


  /**
   * üöÄ D√©marrage du jeu au chargement de la page.
   */
  window.onload = function() {
      if (!determineExercisePaths(lastAnswer)) return;
      setHighPosition(); 

      rhythmMessageElement.textContent = `Pr√™t ?`;
      rhythmMessageElement.style.color = '#00ff00';
      rhythmMessageElement.style.fontSize = '3em';
      
      // D√©marrage simple apr√®s 2 secondes de pr√©paration
      setTimeout(() => {
          rhythmMessageElement.textContent = ''; // Cache le message 'Pr√™t ?'
          
          // La premi√®re note est g√©n√©r√©e apr√®s 0ms, puis le g√©n√©rateur prend le relais.
          addKeyToSequence(); 
          
          // Lancer le g√©n√©rateur continu des notes avec l'intervalle initial
          keyGeneratorInterval = setInterval(addKeyToSequence, keySpacing); 
          
      }, 2000); 
  };
</script>